"""
Recover the toy dataset generated by example/generate_toy/bnmtf/generate_bnmtf.py
using BNMTF-ARD Gibbs.

We can plot the MSE, R2 and Rp as it converges.

We have I=100, J=80, K=5, L=5.
We give flatter priors (1/10) than what was used to generate the data (1).
"""

project_location = "/home/tab43/Documents/Projects/libraries/"
import sys
sys.path.append(project_location)

from BNMTF_ARD.code.models.bnmtf_ard_gibbs import bnmtf_ard_gibbs

import numpy, matplotlib.pyplot as plt, itertools

##########

input_folder = project_location+"BNMTF/experiments/generate_toy/bnmtf/"

iterations = 200
burn_in = 180
thinning = 2
init = 'kmeans'
K, L = 20, 20

alphaR, betaR = 1., 1.
alpha0, beta0 = 1e-14, 1e-14
priors = { 'alphaR':alphaR, 'betaR':betaR, 'alpha0':alpha0, 'beta0':beta0 }

# Load in data
R = numpy.loadtxt(input_folder+"R.txt")
I,J = R.shape
M = numpy.ones((I,J))

# Give the same random initialisation
numpy.random.seed(3)

# Run the Gibbs sampler
BNMTF = bnmtf_ard_gibbs(R,M,K,L,priors)
BNMTF.initialise(init)
BNMTF.run(iterations)

taus = BNMTF.all_tau
lambdaFs = BNMTF.all_lambdaF
lambdaSs = BNMTF.all_lambdaS
lambdaGs = BNMTF.all_lambdaG
Fs = BNMTF.all_F
Ss = BNMTF.all_S
Gs = BNMTF.all_G

# Plot tau against iterations to see that it converges
f, axarr = plt.subplots(4, sharex=True)
x = range(1,len(taus)+1)
axarr[0].set_title('Convergence of values')
axarr[0].plot(x, taus)
axarr[0].set_ylabel("tau")
for k in range(0,K):
    axarr[1].plot(x, 1./lambdaFs[:,k])    
axarr[1].set_ylabel("1/lambdaF")
for k,l in itertools.product(range(0,K),range(0,L)):
    axarr[2].plot(x, 1./lambdaSs[:,k,l])  
axarr[2].set_ylabel("1/lambdaS")
for l in range(0,L):
    axarr[3].plot(x, 1./lambdaGs[:,l])  
axarr[3].set_ylabel("1/lambdaG")
axarr[3].set_xlabel("Iterations")

# Extract the performances across all iterations
print "gibbs_all_performances = %s" % BNMTF.all_performances
